# トラブルシューティングガイド

三位一体開発フレームワーク使用時に発生しうる一般的な問題とその解決策をまとめました。

## 1. Claude Code関連

### 問題: Claude Codeが応答しない、または同じエラーを繰り返す
- **原因**: コンテキストの飽和、誤った前提に基づくループ。
- **解決策**:
    1. **コンテキストリセット**: Claude Code内で `/clear` コマンドを実行して、会話履歴をクリアします。
    2. **手動での視点変更**: Gemini CLIを使って、問題について異なる角度から質問し、その結果をClaudeに伝えます。
       ```bash
       gemini -p "現在[問題の状況]で困っています。[試したこと]をしましたが解決しません。他に考えられる原因やアプローチはありますか？"
       ```
    3. **`/project:stuck-helper` コマンド**: `.claude/commands/stuck-helper.sh` (または同等のカスタムコマンド) を使用して、定義済みのプロンプトでGeminiに助けを求めます。
    4. **具体的な指示**: Claudeに、より具体的で段階的な指示を与えてみてください。
    5. **CLAUDE.mdの見直し**: `CLAUDE.md`の指示が曖昧でないか、誤解を招く可能性がないか確認します。

### 問題: Claude CodeがAPIキーを認識しない
- **原因**: 環境変数の設定ミス、認証情報の期限切れ。
- **解決策**:
    1. **環境変数の確認**: `ANTHROPIC_API_KEY`が正しく設定されているか確認します。Dev Containerを使用している場合は、コンテナ内での環境変数も確認してください。
    2. **再認証**: `claude`コマンドを実行し、再度OAuth認証プロセスを試みます。
    3. **APIキーの有効性確認**: AnthropicのダッシュボードでAPIキーが有効か確認します。

## 2. Gemini CLI関連

### 問題: Gemini CLIが実装やファイル編集をしようとする
- **原因**: Geminiのデフォルトの挙動、`GEMINI.md`の設定不足。
- **解決策**:
    1. **`GEMINI.md`の確認**: `GEMINI.md`で、Geminiの役割が調査、分析、レビューに限定されていることを明確に指示します。特に、「あなたはコードの直接編集やファイル操作を行いません」といった記述が重要です。
    2. **`settings.json`の確認**: Gemini CLIのユーザー設定ファイル (`~/.gemini/settings.json` またはプロジェクト内のサンプル `settings.json.sample` を参照) で、ファイル編集関連のツールが無効化されているか確認します。
       ```json
       "tools": {
         "disabled": [
           "edit",
           "write-file",
           "shell"
         ]
       }
       ```
    3. **プロンプトの工夫**: Geminiに質問する際に、「～について調査してください」「～のメリット・デメリットを教えてください」のように、行動を具体的に指示します。

### 問題: Gemini CLIのレート制限に達する
- **原因**: 無料枠の上限超過。
- **解決策**:
    1. **APIキーの使用**: Google AI StudioでAPIキーを取得し、`GEMINI_API_KEY`環境変数を設定して使用します。
    2. **時間をおく**: 無料枠は時間経過でリセットされるため、しばらく待ってから再試行します。
    3. **問い合わせの最適化**: Geminiへの問い合わせ回数を減らせるよう、質問をまとめて行う、より具体的な質問をするなどの工夫をします。

## 3. Dev Container関連

### 問題: Dev Containerのビルドに失敗する
- **原因**: Dockerfileの構文エラー、ネットワーク問題、ベースイメージの取得失敗。
- **解決策**:
    1. **エラーログ確認**: VS Codeの出力パネルで「Dev Containers」のログを確認し、具体的なエラーメッセージを特定します。
    2. **Dockerfile/devcontainer.jsonの検証**: ファイルの構文が正しいか、特にJSONのカンマや括弧、Dockerfileのコマンドを確認します。
    3. **ネットワーク接続**: Dockerがイメージやパッケージをダウンロードできるか、ネットワーク接続を確認します。プロキシ環境の場合は、Dockerのプロキシ設定も確認してください。
    4. **ベースイメージの存在確認**: Dockerfileの`FROM`で指定しているイメージがDocker Hub等に存在するか確認します。

### 問題: `postCreateCommand`が失敗する
- **原因**: コマンドのタイプミス、必要なパッケージの不足、パーミッションの問題。
- **解決策**:
    1. **コマンドの検証**: `devcontainer.json`の`postCreateCommand`に記述されたコマンドが正しいか、手動でコンテナ内で実行して確認します。
    2. **依存関係**: コマンドが必要とするパッケージ（例: `make`）がDockerfileでインストールされているか確認します。
    3. **パーミッション**: `sudo`が必要なコマンドであれば適切に付与されているか、または`remoteUser`の権限で実行可能か確認します。

## 4. フレームワーク全般

### 問題: ClaudeとGeminiの連携がうまくいかない
- **原因**: `CLAUDE.md`や`GEMINI.md`の指示が不適切、カスタムコマンドの不備、ツールのバージョン非互換。
- **解決策**:
    1. **行動規範ファイルの確認**: `CLAUDE.md`と`GEMINI.md`の内容を再確認し、それぞれの役割と連携方法が明確に記述されているか確認します。特に、ClaudeがGeminiにどのように相談するかの指示が重要です。
    2. **カスタムコマンドのテスト**: `.claude/commands/`内のスクリプトが単体で正しく動作するか確認します。
    3. **ツールのアップデート**: Claude CodeとGemini CLIを最新バージョンにアップデートします。
       ```bash
       npm update -g @anthropic-ai/claude-code @google/gemini-cli
       ```
    4. **シンプルなタスクで試す**: まずは簡単なタスクで連携を試し、問題の箇所を特定します。

### 問題: コンテキストのオーバーフローや混乱
- **原因**: 長時間の会話、多すぎる情報量。
- **解決策**:
    1. **定期的なリセット**: Claude Codeで定期的に`/clear`を実行し、コンテキストを整理します。
    2. **タスクの分割**: 大きな開発タスクは小さなサブタスクに分割し、それぞれ個別に取り組みます。
    3. **要約の活用**: 長い議論の後は、ClaudeやGeminiに要点をまとめさせ、それを新しいコンテキストの出発点とします。
    4. **メモリファイルの活用**: `memory.json`に必要な情報を整理して記述し、Claudeに参照させます。

上記以外で問題が解決しない場合は、各ツールの公式ドキュメントやコミュニティフォーラムも参照してください。
- [Claude Code Documentation](https://docs.anthropic.com/claude-code)
- [Gemini CLI GitHub Issues](https://github.com/google-gemini/gemini-cli/issues)
- [Dev Containers Documentation](https://containers.dev/docs)
